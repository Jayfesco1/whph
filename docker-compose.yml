version: '3.8'

services:
  # 1. TAILSCALE (The Network Gateway)
  tailscale:
    image: tailscale/tailscale:latest
    # Using variable for hostname
    hostname: ${TS_HOSTNAME:-whph} 
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATEFUL_CONFIG=true
      - TS_EXTRA_ARGS=--advertise-tags=tag:server
      - TS_SERVE_CONFIG=/config/serve.json
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./tailscale-config:/config
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - shared_network
      
  # 2. YOUR APP
  whph-server:
    build: .
    network_mode: "service:tailscale" 
    environment:
      - AUDIT_LOG_HOST=audit-log-service
      # Using variable for port
      - AUDIT_LOG_PORT=${AUDIT_LOG_PORT}
    depends_on:
      - tailscale

  # 3. INTERNAL SERVICE
  audit-log-service:
    image: nginx:alpine
    ports:
      - "${AUDIT_LOG_PORT}:${AUDIT_LOG_PORT}"
    networks:
      - shared_network

networks:
  shared_network:
    external: true

volumes:
  tailscale-state:
