services:
  # 1. TAILSCALE (Private Gateway)
  tailscale:
    image: tailscale/tailscale:latest
    hostname: ${TS_HOSTNAME:-whph-server}
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATEFUL_CONFIG=true
      - TS_EXTRA_ARGS=--advertise-tags=tag:server --hostname=whph-server
      - TS_USERSPACE=false
    volumes:
      - tailscale-state:/var/lib/tailscale  # <--- THIS IS THE KEY

      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: always  # Ensure it comes back after a crash
    networks:
      - shared_network
      
  # 2. WHPH SERVER
  whph-server:
    build: .
    network_mode: "service:tailscale" 
    environment:
      - AUDIT_LOG_HOST=audit-log-service
      - AUDIT_LOG_PORT=${AUDIT_LOG_PORT}
    depends_on:
      - tailscale

  # 3. AUDIT LOG SERVICE
  audit-log-service:
    image: nginx:alpine
    networks:
      - shared_network

networks:
  shared_network:
    external: true

volumes:
  tailscale-state:
    name: whph_tailscale_state