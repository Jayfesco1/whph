services:
  tailscale:
    image: tailscale/tailscale:latest
    hostname: whph-server
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATEFUL_CONFIG=true
      # ADD THIS LINE: It forces Tailscale to save keys to the volume
      - TS_STATEDIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:server
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - shared_network

  whph-server:
    build: .
    network_mode: "service:tailscale"
    environment:
      - AUDIT_LOG_HOST=audit-log-service
      - AUDIT_LOG_PORT=${AUDIT_LOG_PORT}
    depends_on:
      - tailscale

  audit-log-service:
    image: nginx:alpine
    networks:
      - shared_network

networks:
  shared_network:
    external: true

volumes:
  tailscale-state:
    name: whph_tailscale_state